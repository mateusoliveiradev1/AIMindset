<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® TESTE EMERGENCIAL - BANCO DE DADOS</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #0a0a0a; 
            color: #00ff00; 
            font-size: 16px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-result { 
            margin: 15px 0; 
            padding: 15px; 
            border-radius: 8px; 
            border: 2px solid;
        }
        .success { 
            background: #001a00; 
            border-color: #00ff00; 
            color: #00ff00;
        }
        .error { 
            background: #1a0000; 
            border-color: #ff0000; 
            color: #ff0000;
        }
        .info { 
            background: #001a1a; 
            border-color: #00ffff; 
            color: #00ffff;
        }
        .warning {
            background: #1a1a00;
            border-color: #ffff00;
            color: #ffff00;
        }
        pre { 
            background: #111; 
            padding: 15px; 
            border-radius: 5px; 
            overflow-x: auto; 
            font-size: 14px;
            border: 1px solid #333;
        }
        button { 
            background: #00ff00; 
            color: #000; 
            border: none; 
            padding: 12px 24px; 
            margin: 8px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 14px;
        }
        button:hover { background: #00cc00; }
        h1 { color: #ff0000; text-align: center; font-size: 24px; }
        h2 { color: #00ffff; }
        .status { font-size: 18px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® DIAGN√ìSTICO EMERGENCIAL - BANCO DE DADOS</h1>
        <h2>Status do Sistema:</h2>
        <div id="status" class="status">üîÑ Iniciando diagn√≥stico...</div>
        
        <div id="results"></div>
        
        <h2>Testes Manuais:</h2>
        <button onclick="testarConexao()">üîç TESTAR CONEX√ÉO</button>
        <button onclick="testarArtigos()">üìÑ TESTAR ARTIGOS</button>
        <button onclick="testarCategorias()">üìÇ TESTAR CATEGORIAS</button>
        <button onclick="testarVariaveis()">‚öôÔ∏è TESTAR VARI√ÅVEIS</button>
        <button onclick="limparResultados()">üßπ LIMPAR</button>
    </div>

    <script>
        // Configura√ß√µes do Supabase
        const supabaseUrl = 'https://jywjqzhqynhnhetidzsa.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5d2pxemhxeW5obmhldGlkenNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5MjkxMzQsImV4cCI6MjA3NjUwNTEzNH0.oTZ6B-77NGBSqa_lN2YWCtnKwKc0glWnwfuN9xQjDl0';
        
        let supabase;
        
        function atualizarStatus(texto, tipo = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = texto;
            statusEl.className = `status ${tipo}`;
        }
        
        function adicionarResultado(tipo, titulo, conteudo) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${tipo}`;
            div.innerHTML = `
                <h3>${titulo}</h3>
                <pre>${conteudo}</pre>
            `;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        function limparResultados() {
            document.getElementById('results').innerHTML = '';
            atualizarStatus('üßπ Resultados limpos');
        }
        
        async function inicializarSupabase() {
            try {
                atualizarStatus('üîÑ Inicializando cliente Supabase...');
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                adicionarResultado('success', '‚úÖ Cliente Supabase Inicializado', 
                    `URL: ${supabaseUrl}\nChave: ${supabaseAnonKey.substring(0, 20)}...`);
                atualizarStatus('‚úÖ Cliente Supabase inicializado com sucesso', 'success');
                return true;
            } catch (err) {
                adicionarResultado('error', '‚ùå Erro ao Inicializar Supabase', err.message);
                atualizarStatus('‚ùå Falha ao inicializar Supabase', 'error');
                return false;
            }
        }
        
        async function testarConexao() {
            if (!supabase) {
                const inicializado = await inicializarSupabase();
                if (!inicializado) return;
            }
            
            adicionarResultado('info', 'üîç Testando Conex√£o B√°sica', 'Iniciando teste de conectividade...');
            
            try {
                const { data, error } = await supabase
                    .from('articles')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    adicionarResultado('error', '‚ùå ERRO NA CONEX√ÉO', 
                        `C√≥digo: ${error.code}\nMensagem: ${error.message}\nDetalhes: ${error.details || 'N/A'}`);
                    atualizarStatus('‚ùå CONEX√ÉO FALHANDO!', 'error');
                } else {
                    adicionarResultado('success', '‚úÖ CONEX√ÉO OK!', 
                        `Resposta do banco: ${JSON.stringify(data, null, 2)}\nTempo: ${new Date().toLocaleTimeString()}`);
                    atualizarStatus('‚úÖ BANCO CONECTADO E FUNCIONANDO!', 'success');
                }
            } catch (err) {
                adicionarResultado('error', 'üí• ERRO CR√çTICO DE REDE', 
                    `Erro: ${err.message}\nStack: ${err.stack}`);
                atualizarStatus('üí• ERRO CR√çTICO!', 'error');
            }
        }
        
        async function testarArtigos() {
            if (!supabase) {
                const inicializado = await inicializarSupabase();
                if (!inicializado) return;
            }
            
            adicionarResultado('info', 'üìÑ Testando Busca de Artigos', 'Buscando artigos na base...');
            
            try {
                const { data, error } = await supabase
                    .from('articles')
                    .select('id, title, slug, published, created_at')
                    .limit(10);
                
                if (error) {
                    adicionarResultado('error', '‚ùå ERRO AO BUSCAR ARTIGOS', 
                        `C√≥digo: ${error.code}\nMensagem: ${error.message}\nDetalhes: ${JSON.stringify(error, null, 2)}`);
                } else {
                    adicionarResultado('success', '‚úÖ ARTIGOS CARREGADOS!', 
                        `Total encontrado: ${data.length}\nArtigos:\n${JSON.stringify(data, null, 2)}`);
                    atualizarStatus(`‚úÖ ${data.length} artigos encontrados!`, 'success');
                }
            } catch (err) {
                adicionarResultado('error', 'üí• ERRO AO BUSCAR ARTIGOS', err.message);
            }
        }
        
        async function testarCategorias() {
            if (!supabase) {
                const inicializado = await inicializarSupabase();
                if (!inicializado) return;
            }
            
            adicionarResultado('info', 'üìÇ Testando Busca de Categorias', 'Buscando categorias...');
            
            try {
                const { data, error } = await supabase
                    .from('categories')
                    .select('id, name, slug, description')
                    .limit(10);
                
                if (error) {
                    adicionarResultado('error', '‚ùå ERRO AO BUSCAR CATEGORIAS', 
                        `C√≥digo: ${error.code}\nMensagem: ${error.message}`);
                } else {
                    adicionarResultado('success', '‚úÖ CATEGORIAS CARREGADAS!', 
                        `Total: ${data.length}\nCategorias:\n${JSON.stringify(data, null, 2)}`);
                    atualizarStatus(`‚úÖ ${data.length} categorias encontradas!`, 'success');
                }
            } catch (err) {
                adicionarResultado('error', 'üí• ERRO AO BUSCAR CATEGORIAS', err.message);
            }
        }
        
        function testarVariaveis() {
            adicionarResultado('info', '‚öôÔ∏è Testando Vari√°veis de Ambiente', 'Verificando configura√ß√µes...');
            
            const variaveis = {
                'URL do Supabase': supabaseUrl,
                'Chave Anon (primeiros 30 chars)': supabaseAnonKey.substring(0, 30) + '...',
                'Chave Anon (√∫ltimos 10 chars)': '...' + supabaseAnonKey.slice(-10),
                'Tamanho da chave': supabaseAnonKey.length,
                'Navegador': navigator.userAgent,
                'Timestamp': new Date().toISOString(),
                'URL atual': window.location.href
            };
            
            adicionarResultado('success', '‚úÖ VARI√ÅVEIS VERIFICADAS', 
                Object.entries(variaveis).map(([k, v]) => `${k}: ${v}`).join('\n'));
        }
        
        // Executar diagn√≥stico autom√°tico ao carregar
        window.onload = async function() {
            atualizarStatus('üöÄ P√°gina carregada - iniciando diagn√≥stico autom√°tico...');
            
            // Aguardar um pouco para garantir que tudo carregou
            setTimeout(async () => {
                await inicializarSupabase();
                setTimeout(() => testarConexao(), 1000);
                setTimeout(() => testarArtigos(), 2000);
                setTimeout(() => testarCategorias(), 3000);
            }, 500);
        };
        
        // Log de erros globais
        window.onerror = function(msg, url, line, col, error) {
            adicionarResultado('error', 'üí• ERRO JAVASCRIPT GLOBAL', 
                `Mensagem: ${msg}\nArquivo: ${url}\nLinha: ${line}\nColuna: ${col}\nErro: ${error}`);
        };
    </script>
</body>
</html>